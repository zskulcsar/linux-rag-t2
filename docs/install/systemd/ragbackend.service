[Unit]
Description=Linux RAG Backend Service
Documentation=https://github.com/linux-rag-t2/linux-rag-t2/tree/main/docs/install
Wants=network-online.target ollama.service weaviate.service phoenix.service
After=network-online.target ollama.service weaviate.service phoenix.service
ConditionPathExists=/opt/linux-rag-t2

[Service]
Type=simple
User=ragcli
Group=ragcli
EnvironmentFile=/etc/ragcli/ragbackend.env
WorkingDirectory=/opt/linux-rag-t2
ExecStart=/usr/bin/env uv run python -m services.rag_backend.main \
  --socket "${RAGCLI_SOCKET}" \
  --weaviate-url "${WEAVIATE_URL}" \
  --ollama-url "${OLLAMA_URL}" \
  --phoenix-url "${PHOENIX_URL}"
ExecStartPre=/usr/bin/env test -S "${RAGCLI_SOCKET}" || /usr/bin/env rm -f "${RAGCLI_SOCKET}"
ExecStartPre=/usr/bin/env mkdir -p "${RAGCLI_RUNTIME_DIR}"
ExecStartPre=/usr/bin/env mkdir -p "${RAGCLI_STATE_DIR}"
ExecStartPre=/usr/bin/env mkdir -p "${RAGCLI_LOG_DIR}"
Environment="PYTHONUNBUFFERED=1"
Restart=on-failure
RestartSec=5s
TimeoutStartSec=60s

# Journaling & logs
StandardOutput=journal
StandardError=journal
SyslogIdentifier=ragbackend

# systemd managed directories (requires systemd 247+)
RuntimeDirectory=ragcli
RuntimeDirectoryMode=0755
StateDirectory=ragcli
StateDirectoryMode=0755
LogsDirectory=ragcli
LogsDirectoryMode=0750

# Security hardening
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes
RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6
RestrictNamespaces=yes
LockPersonality=yes
MemoryDenyWriteExecute=yes
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
SystemCallFilter=@system-service

[Install]
WantedBy=multi-user.target
