# Feature Specification: Local Linux RAG CLI

**Feature Branch**: `001-rag-cli`  
**Created**: 2025-10-30  
**Status**: Draft  
**Input**: User description: "Develop a simple RAG system for Linux that runs locally. The idea here is that the local user can use the command line interface to ask a question about linux and the RAG system will answer based on the locally installed man pages, extra downloadable content like wikis downloaded from the kiwix library as well as local info pages. The idea here is that instead of using man and slowly puzzling things together, the user can use ragman to get the answer. The tool should have two cli interaces: - ragman to ask a question, where the answer is provided by the rag system. This is the primary interface - ragadmin to administer the RAG system, such as managing data sources (man, kiwix, info pages); updating the sources, adding / removing sources."

## Clarifications

### Session 2025-10-30
- Q: How should administrators identify knowledge sources in ragadmin commands? → A: Use unique human-readable aliases derived from source filenames.
- Q: Are administrators allowed to override autogenerated source aliases? → A: No, aliases remain fixed to ensure consistency.
- Q: How should the system handle alias conflicts when auto-generating names from filenames? → A: Append incremental numeric suffixes to retain readability.
- Q: What user model does the RAG system support? → A: Single user with admin-preconfigured backend service.
- Q: What language should knowledge sources and responses prioritize? → A: English as the primary and only guaranteed language.

### Session 2025-10-31
- Q: During `ragadmin init`, which external prerequisites must be verified beyond filesystem setup? → A: Confirm Weaviate readiness and Ollama availability with the default model downloaded.

## User Scenarios & Testing *(mandatory)*

<!--
  IMPORTANT: User stories should be PRIORITIZED as user journeys ordered by importance.
  Each user story/journey must be INDEPENDENTLY TESTABLE - meaning if you implement just ONE of them,
  you should still have a viable MVP (Minimum Viable Product) that delivers value.
  
  Assign priorities (P1, P2, P3, etc.) to each story, where P1 is the most critical.
  Think of each story as a standalone slice of functionality that can be:
  - Developed independently
  - Tested independently
  - Deployed independently
  - Demonstrated to users independently
-->

### User Story 1 - Ask English Linux Questions via ragman (Priority: P1)

The local operator asks an English natural-language question about Linux usage through the `ragman` CLI and receives an English answer synthesized from indexed manuals and offline reference sources.

**Why this priority**: Provides the core value proposition—rapid answers to Linux questions without leaving the terminal or manually searching multiple sources.

**Independent Test**: Run `ragman "How do I change file permissions?"` on a seeded environment and verify the English response contains a direct answer with cited sources from the local knowledge base.

**Acceptance Scenarios**:

1. **Given** the knowledge index is built, **When** the user submits an English question through `ragman`, **Then** the system returns an English answer summarizing relevant instructions and cites at least one source.
2. **Given** the question references content unavailable in indexed sources, **When** the user submits the query, **Then** the CLI returns a clear "no answer found" message plus guidance on updating sources.

---

### User Story 2 - Manage English Sources via ragadmin (Priority: P1)

The administrator maintains English knowledge sources via the `ragadmin` CLI, including listing current sources, adding or removing kiwix zims, refreshing man page snapshots, and rebuilding the index.

**Why this priority**: Without deterministic administration, the knowledge base becomes stale; operations teams need repeatable controls to keep content current.

**Independent Test**: Run `ragadmin sources list`, `ragadmin sources add <english zim>`, and `ragadmin reindex` in a controlled environment and verify the changes are reflected in the catalog and the query interface uses the updated data.

**Acceptance Scenarios**:

1. **Given** an English kiwix archive file, **When** the administrator executes `ragadmin sources add` with that file, **Then** the source catalog shows the new entry marked as English and the next index run includes its content.
2. **Given** outdated content in the index, **When** the administrator runs `ragadmin reindex`, **Then** the system rebuilds the knowledge base and confirms completion via CLI output.

---

### User Story 3 - Local Setup and Health Visibility (Priority: P2)

An operator prepares a fresh machine by initializing the RAG environment, ensuring dependencies are available, verifying storage usage, and checking system health before relying on it.

**Why this priority**: Successful deployment on new hosts requires predictable setup and health checks; without them the service may fail silently.

**Independent Test**: On a clean environment, run `ragadmin init`, confirm required directories and configuration files exist, execute `ragadmin health`, and observe pass/fail indicators for index status, source reachability, and remaining disk capacity.

**Acceptance Scenarios**:

1. **Given** a new environment without prior configuration, **When** the operator runs `ragadmin init`, **Then** configuration directories and default source entries are created with informative output.
2. **Given** the system has missing sources or failed index jobs, **When** the operator runs `ragadmin health`, **Then** the CLI reports failing checks and suggests remediation steps.

---

### Edge Cases

- Index rebuild interrupted by power loss: `ragadmin` MUST resume or restart cleanly without leaving partial indexes; log the recovery step.
- Query exceeds context limits: `ragman` MUST return an English truncation warning and suggest narrowing the question.
- Knowledge source missing or corrupted: `ragadmin` MUST quarantine the source, report the failure, and skip ingestion until corrected.
- Disk space insufficient for downloads or indexing: system MUST abort the operation, emit an actionable English error, and leave existing data intact.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST provide a `ragman` CLI that accepts English natural-language questions and returns concise English answers synthesized from indexed sources within 5 seconds on a typical workstation.
- **FR-002**: Responses from `ragman` MUST include at least one cited source identifier (e.g., man page section, article title) and a confidence indicator, with all answer text delivered in English. Answers MUST be formatted with Summary, Steps, and References sections, use inline source aliases alongside numbered citations, and fall back to the standard guidance when the backend confidence score is below 0.35. Backend responses MUST expose discrete `summary`, ordered `steps`, and `references` fields alongside citation metadata so the CLI can render all sections without inferring structure, and MUST surface the fixed low-confidence guidance string “Answer is below the confidence threshold. Please rephrase your query or refresh sources via ragadmin.” when `confidence` falls below the effective threshold (see FR-012). Responses flagged with `no_answer=true` MAY omit citations; all other responses require at least one citation. A `--plain` CLI flag MUST emit the same sections without markdown styling while preserving inline aliases and numbered references. Citation numbering MUST deduplicate by unique `{alias, document_ref}` pairs so repeated uses reuse the same marker across Summary and Steps, and the References section lists each alias once with its aggregated document references.
- **FR-003**: System MUST provide a `ragadmin` CLI with commands to list, add, update, and remove English knowledge sources for man pages, kiwix archives, and info pages using human-readable aliases derived from source filenames for targeting sources. `ragadmin sources update` behaves as a full replacement for metadata except the alias: it MAY mutate `type`, `location`, `language`, `status`, `checksum`, and `notes` (subject to validation and reingestion), but the alias remains immutable. If the alias must change (for example because a source path is no longer valid), administrators MUST remove the source and add it again with the desired alias.
- **FR-004**: `ragadmin` MUST trigger and monitor index rebuilds, providing progress feedback and explicit success/failure exit codes. Backend responses MUST stream incremental job snapshots over the same Unix-socket request so the CLI renders stage, percent complete, and documents processed while the rebuild runs. The rebuild orchestrator MUST process sources sequentially, skip chunk regeneration when a recomputed checksum matches the stored snapshot, and persist the refreshed ContentIndexVersion alongside the source catalog snapshot once all sources succeed, following the design recorded in `tmp/specs/001-rag-cli/20-11-2025-reindex-design.md`.
- **FR-005**: System MUST support initial bootstrap via `ragadmin init`, which verifies prerequisites (Weaviate readiness plus local Ollama availability with the configured default model downloaded), configures directories, and seeds default source entries.
- **FR-006**: System MUST maintain a local catalog of sources with metadata (type, location, alias, last updated, size) accessible via `ragadmin sources list`, assigning aliases automatically from source filenames and resolving collisions by appending incremental numeric suffixes.
- **FR-007**: System MUST prevent query execution when the index is outdated or corrupt, instead instructing the user to reindex via `ragadmin`.
- **FR-008**: System MUST log administrative actions (add/remove source, reindex, init) to an audit file to support troubleshooting.
- **FR-009**: System MUST provide `ragadmin health` command that checks index freshness, source accessibility, disk capacity thresholds, and reports pass/fail status.
- **FR-010**: System MUST operate entirely offline once sources are downloaded, ensuring no external network calls during query or admin operations.
- **FR-011**: System MUST validate the declared language of each knowledge source, warning administrators when content is not English and recording language metadata in the catalog.
- **FR-012**: System MUST allow operators to override the minimum confidence threshold via `${XDG_CONFIG_HOME}/ragcli/config.yaml`, defaulting to 0.35 seeded by `ragadmin init` when the file is absent. Defaults live under `${XDG_CONFIG_HOME}/ragcli/config.yaml` in the following schema:

  ```yaml
  ragman:
    confidence_threshold: 0.35
    presenter_default: markdown
  ragadmin:
    output_default: table
  ```

  `ragadmin init` MUST create the file when absent and the CLIs MUST honour overrides while retaining offline behaviour.
- **FR-013**: The Weaviate adapter MUST persist each document in a single `Document` class carrying `source_alias`, `source_type`, and `language` metadata with deterministic identifiers so queries can filter by those fields and re-ingestion replaces stale vectors without manual cleanup.

### Key Entities *(include if feature involves data)*

- **Knowledge Source**: Represents a discrete content provider (man page snapshot, kiwix archive, info page directory) with attributes for type, file path, fixed alias, version/date, size, and status (active, pending, error).
- **Content Index**: Aggregated searchable data constructed from active sources, including metadata for build timestamp, document identifiers, and integrity checksum.
- **Query Session**: Captures a single `ragman` interaction including question text, answer summary, cited sources, latency, and confidence score for observability and optional logging.
- **Health Check Result**: Stores the outcome of each subsystem diagnostic (index freshness, disk capacity, source accessibility) with severity level and recommended remediation.

## Assumptions

- Knowledge sources and generated answers focus on English content; other languages are optional enhancements.
- Operators have local filesystem access and sufficient permissions to install and run CLI tools on Linux workstations.
- Kiwix archive downloads occur outside the tool and are provided as local files before ingestion.
- Default manual and info paths follow standard Linux filesystem locations; deviations can be configured via `ragadmin`.
- User base expects English-language responses; multilingual support is out of scope for this release.
- The RAG system serves a single local user; administrators pre-configure the backend service but no multi-user features are required.

## Operational Details

- `ragadmin init` seeds two default sources: `man-pages` (`man`, `/usr/share/man`) and `info-pages` (`info`, `/usr/share/info`) and ensures `${XDG_DATA_HOME}/ragcli/kiwix/` exists without registering a kiwix source.
- All ingestion pipelines MUST perform semantic chunking up to 2 000 tokens per chunk with deterministic IDs `<alias>:<checksum>:<chunk_id>` using SHA256 checksums for content versioning. `embeddinggemma:latest` supplies embeddings and `gemma3:1b` generates answers.
- Reindex progress responses MUST expose the current stage label and, when calculable, a `percent_complete` value. CLI output includes both; when percentage is absent the stage still surfaces.
- `ragman` presents results via markdown (default), plain text (`--plain`), or raw JSON (`--json`). Flags `--context-tokens` (default 4096) and `--conversation` forward values to the backend.
- Disk health WARNs when free space drops to ≤10 % and escalates to FAIL when space falls to ≤8 %, with FAIL taking precedence when both thresholds trigger. Index freshness WARNs when the active build is ≥30 days old. Source accessibility plus Ollama/Weaviate probes honour five exponential retries (0.5 s, 1 s, 2 s, 4 s, 8 s) with 3 s service timeouts and emit concise remediation hints.
- Reference entries include a required `label` plus optional `url` and `notes` fields. Labels SHOULD remain human-readable (e.g., `chmod(1)` or kiwix article titles); the CLI renders the label and hyperlinks the URL when present.
- Audit logging writes newline-delimited JSON entries containing `timestamp`, `action`, `target`, `status`, `trace_id`, and optional `message`/`error_code`; rotation remains an operational concern outside the application.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Operators receive a contextually accurate answer (validated against ground truth questions) for 90% of test queries within 5 seconds at the CLI.
- **SC-002**: Administrative reindex operations complete with a pass/fail status message and exit code, and finish within 10 minutes for a 5 GB content set.
- **SC-003**: Health checks detect and report 100% of simulated failure modes (missing source, low disk space, stale index) during acceptance testing.

### Validation Approach

- Automated latency and reindex performance suites (tasks T042, T054, T073) confirm compliance with SC-001 and SC-002.
- Offline compliance tests (tasks T027–T031, T072) verify FR-010 and ensure CLI/back-end operations remain network-isolated during acceptance.
