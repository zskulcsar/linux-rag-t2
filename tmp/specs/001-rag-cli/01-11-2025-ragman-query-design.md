# ragman Query Flow Design

## Context
The `ragman` CLI delivers mixed query support for “how-to” and troubleshooting questions by calling the backend `/v1/query` endpoint over the shared Unix-socket transport. Answers must default to a three-block layout (Summary, Steps, References) with inline source aliases and numbered citations. A backend confidence score determines whether the CLI presents the full answer or the fallback “No answer found” guidance. The accept threshold is fixed at 0.35, baked into the CLI for now but intended to be configurable later.

## Query Pipeline
When the user runs `ragman <question>`, the Cobra root command captures the positional question, generates a UUID correlation ID, and delegates to `internal/client.Query`. The client wraps `{ question, correlation_id, format: "structured" }` into a newline-delimited JSON frame and sends it through `cli/shared/ipc.Client`. The backend query orchestrator coordinates four ordered stages: (1) hybrid retrieval against Weaviate using the current `ContentIndexVersion` plus lexical boosting, (2) condensation that trims to the best-scoring, source-diverse passages, (3) a generation prompt that returns one summary paragraph and an ordered list of steps, and (4) citation linking that associates each sentence with `{alias, document_ref}` pairs. The orchestrator also calculates an aggregate confidence score based on retrieval coverage, LLM self-confidence, and generator uncertainty, attaching the score and correlation ID to the response payload.

## Rendering & Error Handling
The CLI inspects the backend reply. If `no_answer` is absent and `confidence ≥ 0.35`, `internal/output/structured.Render` prints the Summary paragraph, the numbered Steps list, and a References block that mirrors numbered citations while leaving inline aliases such as `(man chmod)` in place. If the backend flags `no_answer`, the renderer prints the provided message and recommendation bullets. Transport or JSON failures bubble up to the command layer, which logs `QueryCommand.run :: error` and exits with code 2 after printing a user-friendly “backend unreachable” line alongside the correlation ID. Backend 409 “index stale” responses convert into the standard fallback section with a recommendation to run `ragadmin reindex`. Other backend errors use exit code 1 and surface the backend message. Every stage—CLI command, IPC client, backend orchestrator, and adapters—logs with the `Class.method :: step` pattern so the correlation ID ties the trace together.

## Testing Strategy
Go renderer tests in `cli/ragman/internal/output/structured_test.go` exercise successful answers, low-confidence fallbacks, citation numbering, and transport failures. `internal/client/query_test.go` stubs the Unix-socket layer to validate exit codes and messages for success, `no_answer`, stale index, JSON decode errors, and socket timeouts. Contract coverage in `tests/go/contract/ragman_query_test.go` spins up the shared fake backend to verify confident vs. low-confidence pathways and correlation ID propagation. Python unit tests in `tests/python/unit/domain/test_query_orchestrator.py` mock retriever/generator/linker dependencies to assert the 0.35 threshold logic and confidence aggregation. Python integration cases in `tests/python/integration/test_query_flow.py` run the orchestrator with Weaviate and Ollama doubles to confirm hybrid retrieval and prompt orchestration. Observability smoke tests under `tests/python/integration/test_query_logging.py` assert that each stage emits `Class.method :: step` log entries carrying the incoming correlation ID.
